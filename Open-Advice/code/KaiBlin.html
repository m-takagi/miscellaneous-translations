<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ops="http://www.idpf.org/2007/ops" xml:lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <link rel="stylesheet" type="text/css" href="style.css" />
  <meta name="generator" content="Re:VIEW" />
  <title>Writing Patches</title>
</head>
<body>
<h1><a id="h"></a>Writing Patches</h1>
<p><a href="https://github.com/Open-Advice/Open-Advice/blob/master/code/KaiBlin.tex" class="link">The original text</a> (licenced under CC-BY-SA)</p>
<p class="flushright">Kai Blin</p>
<div class="lead">
<p>Kai Blinは計算生物学者で、コンピューターやラボで抗生物質を探す仕事をしている。仕事で開発したソフトウェアをオープンソースライセンスのもとでリリースできたことを、うれしく思っている。ドイツ南部のテュービンゲンで暮らすKaiは、仕事以外ではSambaプロジェクトでのプログラミングにもかかわっている。その他の空き時間は、劇場で過ごすことが多い。舞台に立つこともあれば、舞台や小道具などを組み立てたりといった裏方をこなすこともある。</p>
</div>
<p class="noindent">パッチを書いて送りつけるというのは、オープンソースプロジェクトと実際に関わりを持つための第一歩だ。パッチを書けば、そのプロジェクトの開発者たちに、自分を印象づけられる。はじめてのパッチを「正しく」書くことができれば（正しいかどうかを判断するのはプロジェクト側だが）、ずっと生きやすくなるだろう。</p>
<p>パッチとはどうあるべきものなのか、パッチをプロジェクトに投げるにはどうすればいいのかといった詳細は、プロジェクトによってそれぞれ違ってくることだろう。そんな中で、どんなプロジェクトについてもあてはまる一般的なルールもある。それが、今回の主題だ。</p>

<h2><a id="h-1"></a>状況を悪化させるには</h2>
<p>この本は「あのとき私が知っておきたかったこと」に関するものだ。というわけで、まずは私が初めてパッチを書いたときの話をさせて欲しい。初めて実際のコーディングにかかわったのは、2005年のGoogle Summer of Code™だった。Wineプロジェクトが、Samba関連のツールを元にしたNTLM cryptoの実装を実装することを認めてくれたんだ。Wineはコミッターが1人だけのプロジェクトだ。つまり、リードデベロッパーであるAlexandre Julliardだけが、メインリポジトリへのコミット権を持つ。2005年当時、Wineはまだ、バージョン管理にCVSを使っていた。プロジェクトが始まり、私の申し出が受け入れられたというメールを受け取ったので、メンターをIRC上でつかまえて作業に入った。</p>
<p>順調にコーディングを進めて、最初のフィーチャーを実装し終えた。そこで、パッチを作ってメンターにレビューしてもらった。いにしえのCVS時代、diffのオプションは全部手で指定する必要があったのだけれど、そんなものは事前に調査済みだった。<tt class="inline-code">cvs diff -N -u &gt; ntlm.patch</tt>として作ったファイルを、メンターに送った。実際、これは正しくできたことの一つだった。パッチを作るときにまず考える必要があるのが、これだ。diffコマンドの通常の出力のほうが、機械には読みやすいのかもしれない。しかし、私はこれまで、標準の出力のほうがunified diffよりも読みやすいなどという人に出会ったことはない。<tt class="inline-code">-u</tt>フラグでunified diff形式を有効にすれば、<tt class="inline-code">$+++$</tt>と<tt class="inline-code">$---$</tt>を使ってdiffが出力されるようになる。</p>
<p>たとえば、Pythonの&quot;Hello, world!&quot;プログラムをスウェーデン語版に書き換えたときのdiffは、このようになる。</p>
<div class="emlist-code">
<pre class="emlist">diff --git a/hello.py b/hello.py
index 59dbef8..6334aa2 100644
--- a/hello.py
+++ b/hello.py
@@ -1,4 +1,4 @@
 #!/usr/bin/env python
 # vim: set fileencoding=utf-8

-print &quot;Hello, world!&quot;
+print &quot;Hallå, världen!&quot;
</pre>
</div>
<p><tt class="inline-code">-</tt>で始まる行は削除された行で、<tt class="inline-code">+</tt>で始まる行が追加された行を表す。その他の行は、<tt class="inline-code">patch</tt>コマンドが処理を行うときに使うものだ。</p>
<p>新しく作ったunified diffをメンターに送り、レビューをしてもらった。修正の指摘がたくさんあった。それを直して、新しいdiffを送り直した。GSoCの期間中、こういったコーディングとレビューを繰り返すうちに、パッチのサイズはどんどんふくれあがった。最終日になったときに手元に残ったのは、あらゆる変更が含まれた一つの巨大なパッチだった。当然、そんなパッチをレビューしてもらうのは至難の業だし、コミットする側も大変だろう。Alexandreから、パッチを分割しなければ見てやらないと言われた。Wineのポリシーとして、小規模な論理的手順で機能を追加していくパッチであるべきとされている。各パッチは、何らかの有用な内容であるだけでなく、コンパイルできる必要もある。</p>
<p>巨大なパッチを分割し、それぞれが意味の通っていて<em>かつ</em>コンパイルできるようなものにするというのは大変な作業だ。さらに大変なことに、私自身が巨大なパッチを分割する方法をあまり知らなかった。小さなパッチを書いてdiffを作り、それをコミットしてローカルのチェックアウトを更新し、そしてまた次の小さなパッチを書いていくという方法しか思いつかなかった。小さくしたパッチの第一弾を送って間もなく、Wineは1か月間のフィーチャーフリーズ期間に入った。0.9.0ベータリリースに向けたものだ。次のパッチを送れるようになるまで1か月待つ必要があり、採取的に最後のパッチを送り終えたのは11月のことだった。相当イライラしたので、もう二度とWineコミュニティとは関わらないと決心した。</p>
<p>それ以来ずっとイライラし続けていたが、ある日、私のコードを実際に使っている人から質問を受けたことでイライラは収まった。2006年2月のことだった。私のコードが役に立っているんだ！彼らは機能追加を求めていた。Googleが2006年にもGSoCを開催すると発表したとき、その夏の計画は決まった。Wineは2005年12月にgitへの移行を済ませていた。つまり、仮にコードフリーズがあろうが、小さなパッチをローカルだけで作れるということだ。人生、悪いことばかりじゃない。</p>
<p>&quot;quilt&quot;の挙動をエミュレートするgitフロントエンド（gitな人たちの間ではporcelainと呼ばれているもの）と悪戦苦闘してはじめて、2005年のあのときであっても、もう少しうまくやるためのツールがあったのだろうとわかった。</p>

<h2><a id="h-2"></a>状況を悪化させないためには</h2>
<p>かつての私の失敗談はこれくらいにしておいて、ここからは、そんな落とし穴にはまらないためのヒントを紹介しよう。</p>

<h3><a id="h-2-1"></a>パッチ投稿のガイドライン</h3>
<p>何かのプロジェクトに貢献したいとおもったときには、まずそのプロジェクトのパッチ投稿ガイドラインがないかどうかを確認しよう。コーディングを始める前に調べるべきで、それと同時にそのプロジェクトのコーディングスタイルのガイドラインも確認する。</p>

<h3><a id="h-2-2"></a>Unified diff</h3>
<p>たとえパッチ投稿ガイドラインに明示されていなくても、unified diff形式のパッチを送るようにしよう。いまだかつて、それ以外の形式のdiffを好むプロジェクトに出会ったことはない。unified diff形式のパッチは、とてもレビューしやすい。今どきのバージョン管理システムの多くがdiffのデフォルト出力をunified diff形式にしているのは、偶然でも何でもないんだ。</p>

<h3><a id="h-2-3"></a>分散型バージョン管理の利用</h3>
<p>今時のバージョン管理のことを考えると、分散型バージョン管理システムを使ってローカルで作業できるようにしておきたいところだ。GitやMercurialが使われることが多いが、Bazaarも見るべきところがある。仮に、自分が貢献しようとしているプロジェクトが未だに中央管理型のバージョン管理を使っているのだとしても、自分の変更をイテレーティブにコミットできるようにしておければやりやすい。ここで挙げた分散型バージョン管理システムはすべて、SVNやCVSのコミットをインポートする機能がある。quiltについて学んでみよう。しかし、実際のところ、将来的には分散型バージョン管理の時代になるはずだ。</p>

<h3><a id="h-2-4"></a>小さなパッチで、一度に一つのことだけを行う</h3>
<p>パッチをレビューする立場としては、大きすぎるパッチや一度にいろんなことをしようとしているパッチは、ほんとうに扱いづらいものだ。ひとつのことだけを行っているパッチのほうが、レビューしやすい。もとの作者もパッチを書いた人も見落とした間違いをデバッグすることになったときにも、そのほうがずっと楽だ。</p>

<h3><a id="h-2-5"></a>パッチを追跡する</h3>
<p>パッチを送った後は、そのプロジェクトや自分のパッチについてのやりとりに目を光らせること。一週間たっても何の反応もなければ、改めて反応を求めてみるべきだろう。そのプロジェクトのパッチ対応方針にもよるが、あなたのパッチが他のノイズに紛れ込んでしまっている可能性がある。送ったパッチがそのまますぐに取り込まれるなどと期待しないこと。通常は、そのプロジェクトのスタイルに合わせるために、何回かの調整が必要になる。初めてパッチを送った人がたとえプロジェクトのスタイルに合わせていなかったとしても、それだけで非難されることはない。開発者に指摘された箇所を修正して、パッチを送り直せばいい。</p>

<h2><a id="h-3"></a>結論</h2>
<p>よいパッチを書くのは、決して難しいことではない。考慮すべきことはいくつかあるものの、何度かパッチを書けば自然と身につくだろう。今時の分散型バージョン管理システムを活用すれば、私がここで示したことはすべて実現できる。</p>

<h3><a id="h-3-1"></a>これだけは、覚えて帰ってください…</h3>
<ul>
<li>分散型バージョン管理システムでパッチを管理する</li>
<li>パッチを書くときは、小さめにまとめる</li>
<li>既存のコードのコーディング規約に従う</li>
<li>パッチについてコメントを受けたら、すぐに対応する</li>
</ul>
<p>最初のパッチがうまく受け入れられなかったときには、これらのガイドラインが太助になるだろう。コーディングを楽しもう。</p>
</body>
</html>
