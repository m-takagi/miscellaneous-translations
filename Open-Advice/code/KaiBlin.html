<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ops="http://www.idpf.org/2007/ops" xml:lang="ja">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <link rel="stylesheet" type="text/css" href="style.css" />
  <meta name="generator" content="Re:VIEW" />
  <title>Writing Patches</title>
</head>
<body>
<h1><a id="h"></a>Writing Patches</h1>
<p><a href="https://github.com/Open-Advice/Open-Advice/blob/master/code/KaiBlin.tex" class="link">The original text</a> (licenced under CC-BY-SA)</p>
<p class="flushright">Kai Blin</p>
<div class="lead">
<p>Kai Blinは計算生物学者で、コンピューターやラボで抗生物質を探す仕事をしている。仕事で開発したソフトウェアをオープンソースライセンスのもとでリリースできたことを、うれしく思っている。ドイツ南部のテュービンゲンで暮らすKaiは、仕事以外ではSambaプロジェクトでのプログラミングにもかかわっている。その他の空き時間は、劇場で過ごすことが多い。舞台に立つこともあれば、舞台や小道具などを組み立てたりといった裏方をこなすこともある。</p>
</div>
<p class="noindent">パッチを書いて送りつけるというのは、オープンソースプロジェクトと実際に関わりを持つための第一歩だ。パッチを書けば、そのプロジェクトの開発者たちに、自分を印象づけられる。はじめてのパッチを「正しく」書くことができれば（正しいかどうかを判断するのはプロジェクト側だが）、ずっと生きやすくなるだろう。</p>
<p>パッチとはどうあるべきものなのか、パッチをプロジェクトに投げるにはどうすればいいのかといった詳細は、プロジェクトによってそれぞれ違ってくることだろう。そんな中で、どんなプロジェクトについてもあてはまる一般的なルールもある。それが、今回の主題だ。</p>

<h2><a id="h-1"></a>How to get things wrong</h2>
<p>This book is about ``things we wish we had known when we got started'', so let me get started with the story of my first patches. I first got involved in real coding during the Google Summer of Code™ ~2005. The Wine project had accepted me to implement NTLM crypto based on some Samba-related tool. Wine is a single-committer project, meaning that only the lead developer, Alexandre Julliard, has commit access to the main repository. Back in 2005, Wine still was using CVS as its version control. When the project started and I got the email that I was accepted, I got hold of my mentor on IRC and got to work.</p>
<p>Coding away happily, I got the first features implemented. I produced a patch for my mentor to review. In the olden CVS days, you had to provide all the diff options manually, but I had read up on that part. <tt class="inline-code">cvs diff -N -u &gt; ntlm.patch</tt> and I had the file I could send to my mentor. Actually this is one thing I did get right, and the first thing you should consider when you prepare a patch. The normal output from the diff command might be easier to read for a computer, but I never met a human who actually preferred the normal output over the unified diff output. Switched on by the <tt class="inline-code">-u</tt> flag, this makes diff use the <tt class="inline-code">$+++$</tt> and <tt class="inline-code">$---$</tt> notation.</p>
<p>For example, the following diff is the result of teaching the Python ``Hello, world!'' example program to greet the world in Swedish.</p>
<div class="emlist-code">
<pre class="emlist">diff --git a/hello.py b/hello.py
index 59dbef8..6334aa2 100644
--- a/hello.py
+++ b/hello.py
@@ -1,4 +1,4 @@
 #!/usr/bin/env python
 # vim: set fileencoding=utf-8

-print &quot;Hello, world!&quot;
+print &quot;Hallå, världen!&quot;
</pre>
</div>
<p>The line starting with <tt class="inline-code">-</tt> is the line being removed, the one starting with <tt class="inline-code">+</tt> is the one being added. The other lines are helping the <tt class="inline-code">patch</tt> tool to do its job.</p>
<p>My newly created unified diff was sent to my mentor, who gave me a review and lots of things I could change. I fixed that stuff, and sent him a new diff shortly after. The code--review cycle continued for the whole duration of GSoC, with my patch growing and growing. When the pencils down date arrived, I had a huge monster patch with all my changes in there. Naturally I had a really hard time getting that patch reviewed, let alone committed. In the end, Alexandre refused to look at the patch further before I split it up. Wine policy requires that patches are small logical steps adding functionality. Each patch needs to do something useful <em>and</em> compile.</p>
<p>Now, splitting an existing huge patch up in pieces that individually make sense <em>and</em> compile is a lot of work. It was even more work because the only way I knew this could be done was to write a small patch, create the diff, get that committed, update my local checkout and then write the next small patch. Shortly after I started sending my first small patches, Wine went into a one month feature freeze leading up to the 0.9.0 beta release. I was sitting on my next patch for a month before I could continue, and I eventually got my last patch in in November. I was totally frustrated with the whole experience and decided I did not want to deal with the Wine community anymore.</p>
<p>My frustration held up until people who were actually using my code were starting to ask questions about it in February 2006. My code was actually useful! They wanted more features as well. When Google went on to announce it would be doing GSoC again in 2006, my plans for the summer were clear. Now that Wine had switched to git in December 2005, I knew I would not be held up by possible code freezes, as I finally could create all my small patches locally. Life was good.</p>
<p>It wasn't until I stumbled over a git frontend (called porcelain in git-speak) that emulated the ``quilt'' behavior that I learned that there were tools that could have made my life easier even in 2005.</p>

<h2><a id="h-2"></a>How NOT to get things wrong</h2>
<p>After my tale of how I managed to get things wrong with regard to sending patches, let me continue with a few tips to avoid the pitfalls.</p>

<h3><a id="h-2-1"></a>Patch submission guidelines</h3>
<p>The first tip I have is to read up on any patch submission guidelines the project you want to contribute to might have. Those should actually be consulted before you start coding, along with any coding style guidelines the project has.</p>

<h3><a id="h-2-2"></a>Unified diffs</h3>
<p>Even if not covered in the patch submission guidelines explicitly, you really, really want to send unified diff output. I have yet to meet a project that prefers the non-unified output of diff. Unified diffs make reviewing the patch so much easier. It is no accident that most modern version control programs automatically use that format in their diff command.</p>

<h3><a id="h-2-3"></a>Use distributed version control</h3>
<p>Speaking of modern version control, you will want to use a DVCS to work on the code locally. Git or Mercurial are the most popular choices there, Bazaar might be worth a look as well. Even if the project you want to contribute to still uses a centralized version control, being able to commit your changes iteratively is a great thing. All of the mentioned distributed version control tools should be able to import commits from SVN or CVS. You could go and learn quilt, but seriously, the future is in the field of distributed version control.</p>

<h3><a id="h-2-4"></a>Small patches, doing one thing at a time</h3>
<p>When I have to review patches, patches that are too big or that try to do many things at once are really annoying to deal with. Patches doing only one thing at a time are easier to review. Eventually, they will make your life easier when you finally need to debug the mistakes both the author and the reviewer of the patch missed.</p>

<h3><a id="h-2-5"></a>Track your patch</h3>
<p>After you have submitted your patch, keep an eye on the communication channels of the project and on your patch. If you have not gotten any feedback for a week, you should politely ask for feedback. Depending how the project handles patch submissions, a patch might get lost in the noise. Do not expect to get your patch committed in the first iteration. It usually takes a couple of tries to get used to the style of a new project. As a first-time contributor, nobody will blame you for this, provided you get most of the things right. Just make sure that you fix all of the things the developers indicated and send a second version of the patch.</p>

<h2><a id="h-3"></a>Conclusion</h2>
<p>Writing good patches is not hard. There are a couple of things to consider, but after writing a couple of them you should be on top of those. A modern (distributed) version control system and the workflow you get using it actually take care of most of the things I mentioned.</p>

<h3><a id="h-3-1"></a>If you remember nothing else, remember this...</h3>
<ul>
<li>Use a distributed version control system to manage your patches</li>
<li>Write patches changing code in small, self-contained steps</li>
<li>Follow the existing coding conventions</li>
<li>Respond to comments on your patch promptly</li>
</ul>
<p>The above guidelines should help you to do most if not all things right when submitting your first patches. Happy coding.</p>
</body>
</html>
